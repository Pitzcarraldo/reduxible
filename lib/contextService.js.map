{"version":3,"sources":["../src/contextService.js"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;QAOgB,iB,GAAA,iB;QASA,gB,GAAA,gB;QASA,a,GAAA,a;QAeA,a,GAAA,a;QAiBA,c,GAAA,c;QA4BA,O,GAAA,O;;AArFhB;;;;AACA;;;;;;AAEO,IAAM,kDAAqB,8BAA3B;AACA,IAAM,gDAAoB,6BAA1B;AACA,IAAM,0CAAiB,0BAAvB;;AAEA,SAAS,iBAAT,CAA2B,IAA3B,EAAiC;AACtC,SAAO;AACL,UAAM,kBADD;AAEL,aAAS;AACP;AADO;AAFJ,GAAP;AAMD;;AAEM,SAAS,gBAAT,CAA0B,IAA1B,EAAgC;AACrC,SAAO;AACL,UAAM,iBADD;AAEL,aAAS;AACP;AADO;AAFJ,GAAP;AAMD;;AAEM,SAAS,aAAT,GAAyB;AAC9B,SAAO;AACL,UAAM;AADD,GAAP;AAGD;;AAED,SAAS,aAAT,GAAkD;AAAA,MAA3B,WAA2B,yDAAb,EAAa;;AAAA,oCAAN,IAAM;AAAN,QAAM;AAAA;;AAChD,SAAO,KAAK,MAAL,CACL,UAAC,eAAD,EAAkB,GAAlB,EAA0B;AACxB,QAAI,CAAC,YAAY,GAAZ,CAAL,EAAuB,OAAO,YAAY,GAAZ,CAAP;AACvB,WAAO,eAAP;AACD,GAJI,EAIF,IAJE,CAAP;AAKD;;AAGM,SAAS,aAAT,CAAuB,KAAvB,EAAuD;AAAA,MAAzB,IAAyB,yDAAlB,EAAkB;AAAA,MAAd,OAAc,yDAAJ,EAAI;;AAC5D,MAAI,CAAC,KAAK,MAAN,IAAgB,CAAC,QAAQ,MAA7B,EAAqC,OAAO,qBAAQ,OAAR,EAAP;AACrC,SAAO,yBAAY,mBAAW;AAAA,0BACS,MAAM,QAAN,EADT;;AAAA,QACT,WADS,mBACpB,OADoB,CACT,WADS;;AAE5B,QAAI,gCAAc,WAAd,SAA8B,IAA9B,EAAJ,EAAyC;AACzC,QAAM,eAAe,UAAI,OAAJ,GAAa,kBAAkB,IAAlB,CAAb,GAClB,GADkB,CACd;AAAA,aAAU,qBAAQ,OAAR,CAAgB,MAAM,QAAN,CAAe,MAAf,CAAhB,CAAV;AAAA,KADc,CAArB;AAEA,yBAAQ,GAAR,CAAY,YAAZ,EACG,IADH,CACQ,OADR,WAES,iBAAS;AACd,gCAAQ,qDAAR;AACA,gCAAQ,MAAM,KAAd;AACA,aAAO,QAAQ,MAAM,QAAN,CAAe,iBAAiB,IAAjB,CAAf,CAAR,CAAP;AACD,KANH;AAOD,GAZM,CAAP;AAaD;;AAEM,SAAS,cAAT,CAAwB,GAAxB,EAAyC;AAAA,qCAAT,OAAS;AAAT,WAAS;AAAA;;AAC9C,SAAO;AAAA;;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA,2BASH,iBATG;AAAA,qCASiB;AAAA,cACV,KADU,GACA,KAAK,OADL,CACV,KADU;;AAElB,wBAAc,KAAd,EAAqB,CAAC,GAAD,CAArB,EAA4B,OAA5B;AACD;;AAZE;AAAA;;AAAA,2BAcH,MAdG;AAAA,0BAcM;AACP,iBAAO,iCAAC,yBAAD,EAA+B,KAAK,KAApC,CAAP;AACD;;AAhBE;AAAA;;AAAA;AAAA,gCAEI,YAFJ,GAEmB;AACpB,aAAO,iBAAU,MAAV,CAAiB;AADJ,KAFnB,SAMI,GANJ,GAMU,GANV,SAOI,cAPJ,GAOqB,OAPrB;AAAA,GAAP;AAkBD;;AAED,SAAS,UAAT,GAAuD;AAAA,MAAnC,WAAmC,yDAArB,EAAqB;AAAA,MAAjB,IAAiB,yDAAV,EAAU;AAAA,MAAN,IAAM;;AACrD,SAAO,KAAK,MAAL,CAAY,UAAC,eAAD,EAAkB,GAAlB,EAA0B;AAC3C,oBAAgB,GAAhB,IAAuB,IAAvB,C;AACA,WAAO,eAAP;AACD,GAHM,gCAGC,WAHD,EAAP;AAID;;AAEM,SAAS,OAAT,GAAiE;AAAA,MAAhD,KAAgD,yDAAxC,EAAE,aAAa,EAAf,EAAwC;AAAA;AAAA,MAAjB,IAAiB,QAAjB,IAAiB;AAAA,MAAX,OAAW,QAAX,OAAW;;AACtE,UAAQ,IAAR;AACE,SAAK,kBAAL;AACE,2CAAY,KAAZ,IAAmB,aAAa,WAAW,MAAM,WAAjB,EAA8B,QAAQ,IAAtC,EAA4C,IAA5C,CAAhC;AACF,SAAK,iBAAL;AACE,2CAAY,KAAZ,IAAmB,aAAa,WAAW,MAAM,WAAjB,EAA8B,QAAQ,IAAtC,EAA4C,KAA5C,CAAhC;AACF,SAAK,cAAL;AACA;AACE,YAAM,0CAAiB,KAAjB,CAAN;AACA,eAAO,UAAU,GAAjB;AACA,eAAO,SAAP;AACD;AACD;AACE,aAAO,KAAP;AAZJ;AAcD","file":"contextService.js","sourcesContent":["import React, { Component, PropTypes } from 'react';\r\nimport warning from './warning';\r\n\r\nexport const INITIALIZE_SUCCESS = '@@context/INITIALIZE_SUCCESS';\r\nexport const INITIALIZE_FAILED = '@@context/INITIALIZE_FAILED';\r\nexport const REMOVE_REQUEST = '@@context/REMOVE_REQUEST';\r\n\r\nexport function initializeSuccess(keys) {\r\n  return {\r\n    type: INITIALIZE_SUCCESS,\r\n    payload: {\r\n      keys\r\n    }\r\n  };\r\n}\r\n\r\nexport function initializeFailed(keys) {\r\n  return {\r\n    type: INITIALIZE_FAILED,\r\n    payload: {\r\n      keys\r\n    }\r\n  };\r\n}\r\n\r\nexport function removeRequest() {\r\n  return {\r\n    type: REMOVE_REQUEST\r\n  };\r\n}\r\n\r\nfunction isInitialized(initialized = {}, ...keys) {\r\n  return keys.reduce(\r\n    (prevInitialized, key) => {\r\n      if (!initialized[key]) return initialized[key];\r\n      return prevInitialized;\r\n    }, true);\r\n}\r\n\r\n\r\nexport function preInitialize(store, keys = [], actions = []) {\r\n  if (!keys.length || !actions.length) return Promise.resolve();\r\n  return new Promise(resolve => {\r\n    const { context: { initialized } } = store.getState();\r\n    if (isInitialized(initialized, ...keys)) return;\r\n    const willDispatch = [...actions, initializeSuccess(keys)]\r\n      .map(action => Promise.resolve(store.dispatch(action)));\r\n    Promise.all(willDispatch)\r\n      .then(resolve)\r\n      .catch(error => {\r\n        warning('Failed to PreInitialize. Render with initialStates.');\r\n        warning(error.stack);\r\n        return resolve(store.dispatch(initializeFailed(keys)));\r\n      });\r\n  });\r\n}\r\n\r\nexport function initialActions(key, ...actions) {\r\n  return AsyncInitializedComponent =>\r\n    class Initialize extends Component {\r\n      static contextTypes = {\r\n        store: PropTypes.object.isRequired\r\n      };\r\n\r\n      static key = key;\r\n      static initialActions = actions;\r\n\r\n      componentDidMount() {\r\n        const { store } = this.context;\r\n        preInitialize(store, [key], actions);\r\n      }\r\n\r\n      render() {\r\n        return <AsyncInitializedComponent {...this.props} />;\r\n      }\r\n    };\r\n}\r\n\r\nfunction toggleKeys(initialized = {}, keys = [], flag) {\r\n  return keys.reduce((prevInitialized, key) => {\r\n    prevInitialized[key] = flag; // eslint-disable-line\r\n    return prevInitialized;\r\n  }, { ...initialized });\r\n}\r\n\r\nexport function reducer(state = { initialized: {} }, { type, payload }) {\r\n  switch (type) {\r\n    case INITIALIZE_SUCCESS:\r\n      return { ...state, initialized: toggleKeys(state.initialized, payload.keys, true) };\r\n    case INITIALIZE_FAILED:\r\n      return { ...state, initialized: toggleKeys(state.initialized, payload.keys, false) };\r\n    case REMOVE_REQUEST:\r\n    {\r\n      const nextState = { ...state };\r\n      delete nextState.req;\r\n      return nextState;\r\n    }\r\n    default:\r\n      return state;\r\n  }\r\n}\r\n"]}
{"version":3,"sources":["../src/ReduxibleRouter.js"],"names":[],"mappings":"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","file":"ReduxibleRouter.js","sourcesContent":["import React from 'react';\nimport ReactDOM from 'react-dom';\nimport ReactDOMServer from 'react-dom/server';\nimport Router from 'react-router/lib/Router';\nimport RouterContext from 'react-router/lib/RouterContext';\nimport match from 'react-router/lib/match';\nimport Provider from 'react-redux/lib/components/Provider';\nimport { syncHistoryWithStore } from 'react-router-redux';\nimport { initialize } from './contextService';\nimport warning from './warning';\n\n\nexport default class ReduxibleRouter {\n  constructor(options, history, store) {\n    this.routes = options.routes;\n    this.container = options.container;\n    this.errorContainer = options.errorContainer;\n    this.devTools = options.devTools;\n    this.extras = options.extras;\n    this.history = syncHistoryWithStore(history, store);\n    this.store = store;\n  }\n\n  async renderServer(location) {\n    try {\n      const [redirectLocation, renderProps] = await this.route(this.routes, this.history, location);\n      const { container, store, extras } = this;\n      if (renderProps) await this.preInitialize(store, renderProps.components);\n      const component = this.provide(<RouterContext {...renderProps} />);\n      return {\n        redirectLocation,\n        rendered: ReduxibleRouter.renderComponent({ container, component, store, extras })\n      };\n    } catch (error) {\n      const { errorContainer: container, extras } = this;\n      if (container) {\n        error.component = ReduxibleRouter.renderComponent({ container, error, extras });\n      }\n      throw error;\n    }\n  }\n\n  async renderClient(container, callback) {\n    let router;\n    const components = [];\n    try {\n      const [, renderProps] = await this.route(this.routes, this.history, this.getLocation());\n      components.push(...renderProps.components);\n      router = this.provide(this.getRouter(renderProps));\n    } catch (error) {\n      warning(error);\n      router = this.provide(this.getRouter({}, this.routes, this.history));\n    }\n    ReactDOM.render(router, container, () => {\n      this.preInitialize(this.store, components);\n      if (callback) callback();\n    });\n  }\n\n  async renderClientWithDevTools(container, callback) {\n    let router;\n    const components = [];\n    try {\n      window.React = React;\n      const [, renderProps] = await this.route(this.routes, this.history, this.getLocation());\n      components.push(...renderProps.components);\n      router = this.provide(this.getRouterWithDevTools(renderProps));\n    } catch (error) {\n      warning(error);\n      router = this.provide(this.getRouterWithDevTools({}, this.routes, this.history));\n    }\n    ReactDOM.render(router, container, () => {\n      this.preInitialize(this.store, components);\n      if (callback) callback();\n    });\n  }\n\n  route(routes, history, location) {\n    return new Promise((resolve, reject) => {\n      match({ routes, history, location }, (error, redirectLocation, renderProps) => {\n        if (error) {\n          return reject(error);\n        }\n\n        if (!redirectLocation && !renderProps) {\n          return reject(\n            new Error(\n              'Failed to route. There is no matching path. Please check your routes configuration.'\n            )\n          );\n        }\n\n        if (redirectLocation) {\n          return resolve([redirectLocation]);\n        }\n\n        return resolve([null, renderProps]);\n      });\n    });\n  }\n\n  preInitialize(store, components) {\n    return new Promise(resolve => {\n      const { context: { initialized } } = store.getState();\n      if (initialized) return;\n      const initialActions = [...this.extractActions(components), initialize()];\n      const willDispatch = initialActions.map(action => Promise.resolve(store.dispatch(action)));\n      Promise.all(willDispatch)\n        .then(resolve)\n        .catch(error => {\n          warning('Failed to PreInitialize. Render with initialStates.');\n          warning(error.stack);\n          return resolve(store.dispatch(initialize(false)));\n        });\n    });\n  }\n\n  extractActions(components) {\n    return components.reduce((prevActions, { initialActions }) => {\n      if (initialActions) {\n        prevActions.push(...initialActions); // eslint-disable-line\n      }\n      return prevActions;\n    }, []);\n  }\n\n  provide(children) {\n    return (\n      <Provider store={this.store} key=\"provider\">\n        {children}\n      </Provider>\n    );\n  }\n\n  static renderComponent({ container, component = <div></div>, error, store = {}, extras = {} }) {\n    const Html = container;\n    const state = store && store.getState && { ...store.getState() } || {};\n    if (state && state.context && state.context.req) delete state.context.req;\n    return `<!doctype html>\n      ${ReactDOMServer.renderToString(\n      <Html component={component} error={error} store={store} state={state} { ...extras } />\n    )}`;\n  }\n\n  getLocation() {\n    const { pathname, search, hash } = window.location;\n    return `${pathname}${search}${hash}`;\n  }\n\n  getRouter(renderProps, routes, history) {\n    return <Router {...renderProps} routes={routes} history={history} />;\n  }\n\n  getRouterWithDevTools(renderProps, routes, history) {\n    const DevTools = this.devTools;\n    return (\n      <div>\n        {this.getRouter(renderProps, routes, history)} <DevTools />\n      </div>\n    );\n  }\n}\n"]}